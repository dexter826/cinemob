rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Movies
    match /movies/{document=**} {
      // Đọc / update / delete chỉ khi user là owner
      allow read, update, delete: if
        request.auth != null &&
        request.auth.uid == resource.data.uid;

      // Tạo mới: kiểm tra trên request.resource
      allow create: if
        request.auth != null &&
        request.auth.uid == request.resource.data.uid;
    }

    // Albums
    match /albums/{document=**} {
      // Đọc / update / delete chỉ khi user là owner
      allow read, update, delete: if
        request.auth != null &&
        request.auth.uid == resource.data.uid;

      // Tạo mới: kiểm tra uid trong data gửi lên
      allow create: if
        request.auth != null &&
        request.auth.uid == request.resource.data.uid;
    }

    // Push Subscriptions - user chỉ có thể đọc/ghi subscription của chính mình
    match /push_subscriptions/{userId} {
      // Cho phép read/write/delete nếu userId trùng với auth.uid
      allow read, write, delete: if
        request.auth != null &&
        request.auth.uid == userId;
      
      // Cho phép create nếu document ID = auth.uid
      allow create: if
        request.auth != null &&
        request.auth.uid == userId &&
        request.resource.data.userId == request.auth.uid;
    }
  }
}
